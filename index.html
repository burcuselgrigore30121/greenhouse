<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Greenhouse</title>

    <link rel="icon" type="image/png" href="green-house-logo.png">
    <link rel="apple-touch-icon" href="green-house-logo.png">
    <meta name="theme-color" content="#00b074">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        :root {
            --card: #ffffff;
            --accent: #00b074;
            --accent-soft: #e2f7ef;
            --accent-deep: #059669;
            --accent-dark: #064e3b;
            --text-main: #020617;
            --text-muted: #6b7280;
            --danger: #ef4444;
            --info: #3b82f6; /* Culoare pentru apa */
            --warn: #f59e0b; /* Culoare pentru caldura */
            --radius-lg: 20px;
            --shadow-soft: 0 26px 60px rgba(15, 23, 42, 0.25);
            --shadow-card: 0 18px 40px rgba(15, 23, 42, 0.18);
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Text",
                "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; }

        /* FUNDAL LIVE, MAI DESCHIS */
        body {
            margin: 0;
            padding: 24px;
            min-height: 100vh;
            font-family: var(--font-main);
            font-size: 18px;
            color: var(--text-main);
            background: radial-gradient(circle at 10% 0%, #f0fff4 0, #d7fde8 25%, #baf7d6 45%, #8df6b7 65%, #3ddc97 85%, #0f766e 100%);
            background-size: 220% 220%;
            animation: greenhouseGradient 26s ease-in-out infinite alternate;
        }
        @keyframes greenhouseGradient {
            0%   { background-position: 0% 0%;   }
            25%  { background-position: 50% 0%;   }
            50%  { background-position: 100% 50%; }
            75%  { background-position: 50% 100%; }
            100% { background-position: 0% 50%;   }
        }

        .screen {
            max-width: 480px;
            margin: 0 auto;
        }
        @media (min-width: 900px) {
            .screen { max-width: 1200px; }
            body    { padding: 40px; }
        }

        /* SPLASH */
        #splash {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 0%, #f0fff4 0, #c9ffe1 40%, #4ade80 90%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            transition: opacity 0.6s ease, transform 0.6s ease, visibility 0.6s ease;
        }
        #splash.hide {
            opacity: 0;
            transform: translateY(-16px);
            visibility: hidden;
        }
        .splash-inner { text-align: center; color: #022c22; }
        .splash-logo {
            width: 120px;
            height: 120px;
            border-radius: 32px;
            background: rgba(255,255,255,0.96);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 18px;
            box-shadow: 0 26px 60px rgba(15,23,42,0.38);
            overflow: hidden;
        }
        .splash-logo img { width: 100%; height: 100%; object-fit: contain; }
        .splash-title { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .splash-sub { font-size: 15px; opacity: 0.9; }

        /* TOP BAR */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
        }
        .top-left { display: flex; align-items: center; gap: 14px; }
        .top-logo {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: rgba(255,255,255,0.94);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-soft);
            overflow: hidden;
        }
        .top-logo img { width: 100%; height: 100%; object-fit: contain; }
        .top-text { display: flex; flex-direction: column; gap: 2px; }
        .location-label {
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(15,23,42,0.55);
        }
        .location-name { font-weight: 700; font-size: 26px; letter-spacing: 0.02em; }
        .top-right {
            font-size: 13px;
            color: rgba(255,255,255,0.98);
            text-align: right;
            text-shadow: 0 2px 6px rgba(15,23,42,0.8);
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 5px 11px;
            border-radius: 999px;
            background: rgba(236,253,245,0.95);
            color: #047857;
            font-size: 11px;
            font-weight: 600;
            gap: 6px;
            box-shadow: 0 8px 18px rgba(16,185,129,0.28);
            backdrop-filter: blur(12px);
        }
        .pill-dot {
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
        }
        .pill.disconnected {
            background: rgba(254,242,242,0.96);
            color: var(--danger);
            box-shadow: 0 8px 18px rgba(239,68,68,0.25);
        }
        .pill.disconnected .pill-dot {
            background: var(--danger);
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.35);
        }

        .card {
            background: rgba(255,255,255,0.96);
            border-radius: var(--radius-lg);
            padding: 26px 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-soft);
            backdrop-filter: blur(18px);
            border: 1px solid rgba(255,255,255,0.9);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-title { font-size: 20px; font-weight: 600; }
        
        /* GRILA DE SENZORI (din tabul principal) */
        .sensors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (min-width: 900px) {
            .sensors-grid { grid-template-columns: repeat(4, 1fr); }
        }
        .sensor-item {
            background: var(--accent-soft);
            border-radius: 16px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid rgba(255,255,255,0.8);
            box-shadow: var(--shadow-card);
        }
        .sensor-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sensor-icon { font-size: 18px; }
        .sensor-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--accent-dark);
            line-height: 1.1;
        }
        .sensor-value sup { font-size: 0.5em; font-weight: 600; }
        
        /* TABS */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
        }
        .tab-item {
            font-size: 16px;
            font-weight: 600;
            padding: 14px 22px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-muted);
            cursor: pointer;
            position: relative;
            /* Umbra subtila by default */
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .tab-item.active {
            background: var(--card);
            color: var(--text-main);
            /* Umbra 3D mai puternica pentru tab-ul activ */
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.22);
            transform: translateY(-3px);
            z-index: 1;
        }
        /* Efect HOVER pe tab-urile inactive */
        .tab-item:not(.active):hover {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 16px 32px rgba(15, 23, 42, 0.28);
            z-index: 2; /* Il aduce in fata */
            color: var(--text-main);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* BUTOANE AUTO/MANUAL */
        .mode-switcher {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
        }
        .mode-btn {
            flex: 1;
            font-size: 16px;
            font-weight: 700;
            padding: 16px;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.6);
            color: var(--text-muted);
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.1);
            transition: all 0.3s ease;
        }
        .mode-btn.active {
            background: var(--accent-deep);
            color: white;
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
        }
        .mode-btn:not(.active):hover {
            background: rgba(255, 255, 255, 0.8);
            color: var(--text-main);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.15);
        }

        /* GRILA DE CONTROALE MANUALE */
        .manual-controls {
            /* Ascuns by default, JS il va afisa */
            display: none; 
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (min-width: 900px) {
            .manual-controls { grid-template-columns: repeat(4, 1fr); }
        }

        .control-card {
            background: var(--card);
            border-radius: var(--radius-lg);
            padding: 22px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative; /* Pentru pseudo-elemente */
            overflow: hidden; /* Pentru water-fill si lamp-glow */
        }
        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            position: relative;
            z-index: 2;
        }
        .control-label {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-main);
        }
        .control-icon {
            font-size: 24px;
            color: var(--text-muted);
        }
        .control-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            margin-top: 10px;
            position: relative;
            z-index: 2;
        }
        .control-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-main);
        }
        .control-value sup {
            font-size: 0.5em;
            font-weight: 600;
            color: var(--text-muted);
        }
        
        /* Slider customizat */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #e5e7eb;
            outline: none;
            transition: background 0.3s ease;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 3px solid var(--card);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 3px solid var(--card);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* ----- STILURI SPECIFICE CONTROALE ----- */
        
        /* 1. FAN SPEED (Ventilator) */
        .fan-icon-wrapper {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .fan-icon {
            width: 44px;
            height: 44px;
            position: relative;
            /* By default e oprita. JS adauga 'spinning' si seteaza durata */
            animation: spin 5s linear infinite; 
            animation-play-state: paused;
        }
        .fan-icon.spinning {
            animation-play-state: running;
        }
        .fan-icon .blade {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--text-muted);
            border-radius: 30% 70% 30% 70% / 50% 50% 50% 50%;
            transition: background 0.3s ease;
        }
        .fan-icon.spinning .blade {
            background: var(--accent-deep);
        }
        .fan-icon .blade1 { top: 0; left: 0; }
        .fan-icon .blade2 { top: 0; right: 0; transform: rotate(90deg); }
        .fan-icon .blade3 { bottom: 0; left: 0; transform: rotate(-90deg); }
        .fan-icon .blade4 { bottom: 0; right: 0; transform: rotate(180deg); }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 2. LAMP HEAT (Caldura) */
        .control-lamp {
            color: var(--warn);
        }
        .lamp-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
            /* Box-shadow va fi setat de JS */
            box-shadow: none;
            transition: box-shadow 0.4s ease-out;
        }
        .control-lamp .control-icon { color: var(--warn); }
        .control-lamp .slider::-webkit-slider-thumb { background: var(--warn); }
        .control-lamp .slider::-moz-range-thumb { background: var(--warn); }
        .control-lamp .control-value { color: #d97706; }
        
        /* 3. EXTRA (ex. Lumina) */
        .control-extra .control-icon { color: #d946ef; }
        .control-extra .slider::-webkit-slider-thumb { background: #d946ef; }
        .control-extra .slider::-moz-range-thumb { background: #d946ef; }
        .control-extra .control-value { color: #c026d3; }

        /* 4. WATER PUMP (Pompa Apa) */
        .control-water .control-icon { color: var(--info); }
        .control-water .slider::-webkit-slider-thumb { background: var(--info); }
        .control-water .slider::-moz-range-thumb { background: var(--info); }
        .control-water .control-value { color: #2563eb; }
        
        .water-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            width: 100%;
            /* Inaltimea e setata de JS */
            height: 0%; 
            background: linear-gradient(45deg, #3b82f6, #60a5fa, #93c5fd);
            background-size: 200% 200%;
            z-index: 1;
            border-radius: 0 0 var(--radius-lg) var(--radius-lg);
            transition: height 0.4s ease-out;
            /* Animatia de "flow" */
            animation: waterFlow 4s ease-in-out infinite alternate;
        }
        @keyframes waterFlow {
            0%   { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

    </style>
</head>
<body>

    <div id="splash">
        <div class="splash-inner">
            <div class="splash-logo">
                <img src="green-house-logo.png" alt="Greenhouse Logo">
            </div>
            <div class="splash-title">Smart Greenhouse</div>
            <div class="splash-sub">Se conecteazƒÉ la broker...</div>
        </div>
    </div>

    <div class="screen">

        <div class="top-bar">
            <div class="top-left">
                <div class="top-logo">
                    <img src="green-house-logo.png" alt="Logo">
                </div>
                <div class="top-text">
                    <div class="location-label">Loca»õie</div>
                    <div class="location-name">Sera 1</div>
                </div>
            </div>
            <div class="top-right">
                <div id="connection-status" class="pill disconnected">
                    <div class="pill-dot"></div>
                    <span id="status-text">DECONECTAT</span>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab-item active" data-tab="principal">üå± Tabul Principal</div>
            <div class="tab-item" data-tab="setari">‚öôÔ∏è SetƒÉri</div>
        </div>

        <div class="mode-switcher">
            <button id="btn-auto" class="mode-btn active" onclick="setMode('auto')">MOD AUTO</button>
            <button id="btn-manual" class="mode-btn" onclick="setMode('manual')">MOD MANUAL</button>
        </div>

        <div class="tabs-content">
            <div id="tab-principal" class="tab-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Starea CurentƒÉ</div>
                    </div>
                    <div class="sensors-grid">
                        <div class="sensor-item">
                            <div class="sensor-label"><span class="sensor-icon">üå°Ô∏è</span>Temp. Aer</div>
                            <div class="sensor-value" id="val-temp-aer">--<sup>¬∞C</sup></div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label"><span class="sensor-icon">üíß</span>Umid. Aer</div>
                            <div class="sensor-value" id="val-umid-aer">--<sup>%</sup></div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label"><span class="sensor-icon">üå±</span>Umid. Sol</div>
                            <div class="sensor-value" id="val-umid-sol">--<sup>%</sup></div>
                        </div>
                        <div class="sensor-item">
                            <div class="sensor-label"><span class="sensor-icon">‚òÄÔ∏è</span>LuminƒÉ</div>
                            <div class="sensor-value" id="val-lumina">--<sup>lx</sup></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-setari" class="tab-content">
                <div class="card">
                    <div class="card-title">SetƒÉri Conexiune</div>
                    <p>Aici vor fi setƒÉrile pentru broker-ul MQTT, etc.</p>
                </div>
            </div>
        </div>

        <div class="manual-controls" id="manual-controls-grid">
            
            <div class="control-card" id="control-fan">
                <div class="control-header">
                    <div class="control-label">VitezƒÉ Ventilator</div>
                </div>
                <div class="control-body">
                    <div class="fan-icon-wrapper">
                        <div class="fan-icon" id="fan-icon-css">
                            <div class="blade blade1"></div>
                            <div class="blade blade2"></div>
                            <div class="blade blade3"></div>
                            <div class="blade blade4"></div>
                        </div>
                    </div>
                    <div class="control-value" id="fan-val-text">0<sup>%</sup></div>
                </div>
                <input type="range" min="0" max="100" value="0" class="slider" id="slider-fan">
            </div>

            <div class="control-card control-lamp" id="control-heat">
                <div class="lamp-glow" id="lamp-glow-effect"></div>
                <div class="control-header">
                    <div class="control-label">Intensitate CƒÉldurƒÉ</div>
                    <div class="control-icon">üî•</div>
                </div>
                <div class="control-body">
                    <div class="control-value" id="heat-val-text">0<sup>%</sup></div>
                </div>
                <input type="range" min="0" max="100" value="0" class="slider" id="slider-heat">
            </div>

            <div class="control-card control-extra" id="control-extra">
                <div class="control-header">
                    <div class="control-label">LuminƒÉ Extra</div>
                    <div class="control-icon">üí°</div>
                </div>
                <div class="control-body">
                    <div class="control-value" id="extra-val-text">0<sup>%</sup></div>
                </div>
                <input type="range" min="0" max="100" value="0" class="slider" id="slider-extra">
            </div>

            <div class="control-card control-water" id="control-water">
                <div class="water-fill" id="water-fill-effect"></div>
                <div class="control-header">
                    <div class="control-label">PompƒÉ ApƒÉ</div>
                    <div class="control-icon">üåä</div>
                </div>
                <div class="control-body">
                    <div class="control-value" id="water-val-text">0<sup>%</sup></div>
                </div>
                <input type="range" min="0" max="100" value="0" class="slider" id="slider-water">
            </div>

        </div>

    </div>

    <script>
        // Configurare MQTT (DEMO - ajusteaza cu datele tale)
        const brokerHost = "test.mosquitto.org";
        const brokerPort = 8081; // Port WebSocket
        const clientId = "greenhouse-ui-" + Math.random().toString(16).substr(2, 8);

        // Topice
        const TOPIC_STATUS = "greenhouse/status";
        const TOPIC_SENSORS = "greenhouse/sensors";
        const TOPIC_MODE = "greenhouse/control/mode";
        const TOPIC_CMD_FAN = "greenhouse/control/fan";
        const TOPIC_CMD_HEAT = "greenhouse/control/heat";
        const TOPIC_CMD_EXTRA = "greenhouse/control/extra";
        const TOPIC_CMD_WATER = "greenhouse/control/water";

        let client;
        let isManualMode = false;
        let reconnectTimeout = 5000;

        // --- Functii UI de Baza ---
        
        function setupTabs() {
            const tabs = document.querySelectorAll('.tab-item');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Doar daca nu e deja activ
                    if (tab.classList.contains('active')) return;

                    // Scoate active de la toate
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));

                    // Adauga active la cel click-uit
                    tab.classList.add('active');
                    const targetContent = document.getElementById(tab.dataset.tab);
                    if (targetContent) {
                        targetContent.classList.add('active');
                    }
                });
            });
        }
        
        // NOUA Functie pentru setarea modului Auto/Manual
        function setMode(mode) {
            const tabsContent = document.querySelector('.tabs-content');
            const manualControls = document.getElementById('manual-controls-grid');
            const btnAuto = document.getElementById('btn-auto');
            const btnManual = document.getElementById('btn-manual');

            if (mode === 'auto') {
                isManualMode = false;
                tabsContent.style.display = 'block';
                manualControls.style.display = 'none';
                btnAuto.classList.add('active');
                btnManual.classList.remove('active');
                // Trimite comanda MQTT
                publishMessage(TOPIC_MODE, "AUTO");

            } else if (mode === 'manual') {
                isManualMode = true;
                tabsContent.style.display = 'none';
                manualControls.style.display = 'grid'; // Sau 'grid'
                btnAuto.classList.remove('active');
                btnManual.classList.add('active');
                // Trimite comanda MQTT
                publishMessage(TOPIC_MODE, "MANUAL");
            }
        }

        function updateConnectionStatus(connected, message = "") {
            const statusPill = document.getElementById('connection-status');
            const statusText = document.getElementById('status-text');
            const splashScreen = document.getElementById('splash');

            if (connected) {
                statusPill.classList.remove('disconnected');
                statusText.innerText = "CONECTAT";
                
                // Ascunde splash screen-ul dupa o mica intarziere
                setTimeout(() => {
                    splashScreen.classList.add('hide');
                }, 800);
            } else {
                statusPill.classList.add('disconnected');
                statusText.innerText = message || "DECONECTAT";
                // Arata splash screen-ul daca pica conexiunea
                if (!splashScreen.classList.contains('hide')) {
                     document.querySelector('.splash-sub').innerText = message;
                }
            }
        }
        
        // --- Functii UI pentru Controale Manuale ---

        // 1. FAN (Ventilator)
        function updateFanUI(value) {
            const text = document.getElementById('fan-val-text');
            const icon = document.getElementById('fan-icon-css');
            text.innerHTML = `${value}<sup>%</sup>`;

            if (value > 0) {
                icon.classList.add('spinning');
                // Viteza creste (durata animatiei scade)
                // 3s la viteza minima (1), 0.3s la viteza maxima (100)
                let duration = 3.3 - (value / 100 * 3); 
                icon.style.animationDuration = `${duration}s`;
            } else {
                icon.classList.remove('spinning');
            }
        }

        // 2. HEAT (Caldura) - Functie Modificata
        function updateHeatUI(value) {
            const text = document.getElementById('heat-val-text');
            const glow = document.getElementById('lamp-glow-effect');
            text.innerHTML = `${value}<sup>%</sup>`;

            if (value > 0) {
                // Calcule progresive
                let opacity = 0.1 + (value / 100 * 0.6); // 0.1 -> 0.7
                let blur = 10 + (value * 0.7);        // 10px -> 80px
                let spread = 4 + (value * 0.2);         // 4px -> 24px
                
                // Seteaza umbra progresiv
                glow.style.boxShadow = `0 0 ${blur}px ${spread}px rgba(251, 191, 36, ${opacity})`;
            } else {
                glow.style.boxShadow = 'none';
            }
        }

        // 3. EXTRA
        function updateExtraUI(value) {
            document.getElementById('extra-val-text').innerHTML = `${value}<sup>%</sup>`;
            // Aici poti adauga si alte efecte vizuale
        }

        // 4. WATER (Apa) - Functie Modificata
        function updateWaterUI(value) {
            const text = document.getElementById('water-val-text');
            const fill = document.getElementById('water-fill-effect');
            text.innerHTML = `${value}<sup>%</sup>`;
            
            // Seteaza inaltimea elementului de "umplere"
            fill.style.height = `${value}%`;
        }

        // --- Initializare Controale Manuale (Sliders) ---
        function setupManualControls() {
            const fanSlider = document.getElementById('slider-fan');
            const heatSlider = document.getElementById('slider-heat');
            const extraSlider = document.getElementById('slider-extra');
            const waterSlider = document.getElementById('slider-water');

            fanSlider.addEventListener('input', (e) => updateFanUI(e.target.value));
            heatSlider.addEventListener('input', (e) => updateHeatUI(e.target.value));
            extraSlider.addEventListener('input', (e) => updateExtraUI(e.target.value));
            waterSlider.addEventListener('input', (e) => updateWaterUI(e.target.value));

            // Adaugam 'change' pentru a trimite comanda MQTT doar la final
            fanSlider.addEventListener('change', (e) => publishMessage(TOPIC_CMD_FAN, e.target.value));
            heatSlider.addEventListener('change', (e) => publishMessage(TOPIC_CMD_HEAT, e.target.value));
            extraSlider.addEventListener('change', (e) => publishMessage(TOPIC_CMD_EXTRA, e.target.value));
            waterSlider.addEventListener('change', (e) => publishMessage(TOPIC_CMD_WATER, e.target.value));
        }

        // --- Logica MQTT ---
        
        function connectMQTT() {
            try {
                client = new Paho.MQTT.Client(brokerHost, brokerPort, clientId);

                // Setare callbacks
                client.onConnectionLost = onConnectionLost;
                client.onMessageArrived = onMessageArrived;

                // Conectare
                client.connect({
                    onSuccess: onConnect,
                    onFailure: onFailure,
                    useSSL: true, // Portul 8081 e de obicei WSS (WebSocket Secure)
                    cleanSession: true,
                    timeout: 10
                });
            } catch (error) {
                console.error("Eroare initializare MQTT:", error);
                updateConnectionStatus(false, "Eroare client");
                setTimeout(connectMQTT, reconnectTimeout);
            }
        }

        function onConnect() {
            console.log("Conectat la MQTT Broker!");
            updateConnectionStatus(true);
            
            // Subscrie la topice
            client.subscribe(TOPIC_STATUS);
            client.subscribe(TOPIC_SENSORS);
            // Daca vrei ca UI-ul sa reflecte si starea din spate (ex. alt user schimba)
            // client.subscribe(TOPIC_MODE);
            // client.subscribe(TOPIC_CMD_FAN); 
            // ... etc
        }

        function onFailure(response) {
            console.log("Conectare esuata: " + response.errorMessage);
            updateConnectionStatus(false, "Conexiune esuata");
            setTimeout(connectMQTT, reconnectTimeout);
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("Conexiune pierduta: " + responseObject.errorMessage);
                updateConnectionStatus(false, "Conexiune pierduta");
                setTimeout(connectMQTT, reconnectTimeout);
            }
        }

        function onMessageArrived(message) {
            const topic = message.destinationName;
            const payload = message.payloadString;
            console.log("Mesaj primit: ", topic, payload);

            try {
                if (topic === TOPIC_SENSORS) {
                    const data = JSON.parse(payload);
                    document.getElementById('val-temp-aer').innerHTML = `${data.temp_aer?.toFixed(1) || '--'}<sup>¬∞C</sup>`;
                    document.getElementById('val-umid-aer').innerHTML = `${data.umid_aer?.toFixed(0) || '--'}<sup>%</sup>`;
                    document.getElementById('val-umid-sol').innerHTML = `${data.umid_sol?.toFixed(0) || '--'}<sup>%</sup>`;
                    document.getElementById('val-lumina').innerHTML = `${data.lumina || '--'}<sup>lx</sup>`;
                }
                
                if (topic === TOPIC_STATUS && payload === "OFFLINE") {
                     updateConnectionStatus(false, "Sera OFFLINE");
                }
                
                // Aici poti adauga logica si pentru a updata sliderele
                // daca primesti mesaje pe topicele de comanda (daca nu e in mod manual)
                // if (topic === TOPIC_CMD_FAN && !isManualMode) { ... }

            } catch (error) {
                console.error("Eroare la procesarea mesajului:", error);
            }
        }

        function publishMessage(topic, payload) {
            if (!client || !client.isConnected()) {
                console.warn("Nu se poate publica, clientul nu e conectat.");
                return;
            }
            try {
                const message = new Paho.MQTT.Message(payload);
                message.destinationName = topic;
                message.qos = 0; // Quality of Service
                message.retained = false;
                client.send(message);
                console.log(`Mesaj publicat: ${topic} -> ${payload}`);
            } catch (error) {
                console.error("Eroare la publicare:", error);
            }
        }

        // --- Initializare Aplicatie ---
        document.addEventListener('DOMContentLoaded', () => {
            setupTabs();
            setupManualControls();
            setMode('auto'); // Seteaza modul initial ca AUTO
            connectMQTT();
        });
    </script>
</body>
</html>
